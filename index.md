# ЕРВУ: Полный разбор архитектуры Единого реестра воинского учёта

## Введение

ЕРВУ (Единый реестр воинского учёта) — это федеральная информационная система, созданная для централизованного учёта военнообязанных граждан РФ. Система объединяет данные из множества государственных источников, автоматизирует процессы призыва и применения ограничительных мер к уклонистам.

Данный разбор основан на технической документации, схемах баз данных, BPMN-диаграммах процессов и архитектурных схемах системы.

---

## Часть 1. Архитектура системы

### 1.1. Сетевая топология

Система разделена на три сегмента:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    INTERNET     │    │   ЕРВУ (DMZ)    │    │ ЕРВУ (ЗАКРЫТЫЙ) │
│                 │    │                 │    │                 │
│  - Браузеры ФЛ  │───▶│  - Load Balancer│───▶│  - Core Services│
│  - Браузеры ЮЛ  │    │  - Web-серверы  │    │  - Databases    │
│  - ЕПГУ         │    │  - Антивирус    │    │  - Kafka        │
│  - ЕСИА         │    │  - Файл.буферы  │    │  - MinIO (S3)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

**DMZ-сегмент** выполняет функции:
- Балансировка нагрузки (Angie PRO)
- Антивирусная проверка файлов (Kaspersky)
- Временное хранение файлов до проверки
- Раздача статического контента

**Закрытый сегмент** содержит:
- Основные микросервисы (Java)
- Брокер сообщений (Kafka)
- Объектное хранилище (MinIO/S3)
- Базы данных

### 1.2. Микросервисная архитектура

Система построена на ~40 микросервисах. Ключевые:

| Сервис | Назначение |
|--------|------------|
| `ervu-person-registry` | Реестр военнообязанных (персональные данные) |
| `ervu-subpoena-registry` | Реестр повесток |
| `ervu-summon-list-registry` | Списки на вызов |
| `ervu-decision-document-service` | Документы решений |
| `ervu-incidents-service` | Инциденты (ошибки данных) |
| `ervu-import-service` | Импорт данных из внешних систем |
| `ervu-journal-service` | Журналирование всех действий |
| `ervu-application-gateway` | Маршрутизация заявлений |
| `workflow-service` | Оркестрация бизнес-процессов (Camunda) |
| `proxy-gateway` | API Gateway с авторизацией |
| `notifier-*` | Подсистема уведомлений |
| `mz-adapter` | Адаптер межведомственного взаимодействия |
| `wf-smev-gateway` | Шлюз к СМЭВ |

### 1.3. Технологический стек

- **Backend:** Java (Libercat — вероятно, форк Tomcat)
- **Frontend:** SPA (раздаётся через Angie PRO)
- **Message Broker:** Apache Kafka
- **Object Storage:** MinIO (S3-совместимое)
- **Workflow Engine:** Camunda
- **Cache:** Redis
- **Антивирус:** Kaspersky
- **Web Server:** Angie PRO (российский форк Nginx)

### 1.4. Интеграции

Система интегрирована с государственными системами через СМЭВ:

| Система | Данные |
|---------|--------|
| ФНС | Места работы, ИП, ОГРН, ИНН |
| СФР (ПФР) | Трудовой стаж, пенсионные данные |
| МВД | Паспортные данные, регистрация, судимости |
| Минобрнауки | Данные об образовании |
| ГИБДД | Водительские удостоверения |
| ФСБ | Запрет на выезд |
| Росреестр | Недвижимость |
| ЦБ/Банки | Кредитные ограничения |
| ЕСИА | Аутентификация пользователей |
| ЕПГУ | Приём заявлений от граждан |
| ЕРН | Единый регистр населения (идентификатор id_ern) |
| ГИР ВУ | Государственный информационный ресурс воинского учёта |

---

## Часть 2. Модель данных

### 2.1. Гражданин (recruits)

Центральная сущность системы — запись о военнообязанном:

```
recruits
├── id (guid) — внутренний идентификатор
├── system_id_ern — идентификатор в ЕРН (единый на всю РФ)
├── system_doc_id — военный идентификатор
├── ФИО, дата рождения, пол
├── СНИЛС, ИНН
├── Контакты (телефон, email)
├── addresses (jsonb) — массив адресов
├── system_pgs_status — статус гражданина в системе
├── current_recruitment_id — текущий военкомат
├── target_recruitment_id — целевой военкомат
├── military_registration_date — дата постановки на учёт
├── death_date — дата смерти
├── vu_unset_date — дата снятия с учёта
└── conscription — наличие отсрочки
```

### 2.2. Расширенные данные (recruits_info)

JSON-поле `info` содержит агрегированные данные из всех источников:

**Семейное положение:**
```json
{
  "family": {
    "status": "Б",
    "hasChildren": true,
    "countLittleChildren": 1,
    "spouse": {
      "lastName": "...",
      "firstName": "...",
      "dateBirthday": "..."
    },
    "children": [...]
  }
}
```

**Трудоустройство:**
```json
{
  "workPlaces": [{
    "inn": "0265007932",
    "fullName": "ООО Рога и Копыта",
    "periodStart": "2021-08-02",
    "periodEnd": null,
    "position": "Инженер",
    "mainWork": true,
    "legalAddress": "...",
    "factAddress": "..."
  }]
}
```

**Образование:**
```json
{
  "educationInfo": {
    "universities": [{
      "name": "ВГУ",
      "speciality": "Программная инженерия",
      "educationType": "Очная",
      "educationStartDate": "2008-08-16",
      "educationEndDate": "2014-03-10",
      "graduationLevel": "Высшее"
    }],
    "educationStatus": "Завершил",
    "academicLeave": false
  }
}
```

**Медицинские данные:**
```json
{
  "med": {
    "code": "-",
    "group": "3",
    "dispensary": ""
  }
}
```

**Водительские удостоверения:**
```json
{
  "driverLicenses": [{
    "type": "DRIVER_LICENSE",
    "series": "7414",
    "number": "292010",
    "categories": ["B", "B1", "M"],
    "startDate": "2014-12-22",
    "endDate": "2024-12-22",
    "status": "CORRECT"
  }]
}
```

**Уголовная ответственность:**
```json
{
  "criminalInfo": {
    "criminalRecords": [{
      "record": "Имеет снятую, погашенную судимость"
    }],
    "wanted": {
      "dateWanted": null,
      "wantedArticle": null
    },
    "convictions": [{
      "dateConvictions": "...",
      "courtName": "...",
      "article": "...",
      "typePunishment": "...",
      "servingSentence": true,
      "dateStart": "...",
      "plannedDate": "..."
    }]
  }
}
```

**Отсрочки:**
```json
{
  "postponements": [{
    "delayCode": "01",
    "delay": true,
    "reason": "Обучение в ВУЗе",
    "delayType": "По образованию",
    "endDate": "2025-06-30",
    "numberDoc": "123",
    "dateDoc": "2023-09-01"
  }]
}
```

**Иностранное гражданство и выезды:**
```json
{
  "foreign": [{
    "rights": "Гражданство",
    "country": "Израиль",
    "dateRights": "2020-05-15"
  }],
  "travel": [{
    "dateLeave": "2022-03-01",
    "return": false,
    "message": true,
    "dateMessage": "2022-03-01"
  }]
}
```

### 2.3. Документы гражданина

Система хранит несколько типов документов:

**ДУЛ (documents)** — документы, удостоверяющие личность:
- Паспорт РФ
- Загранпаспорт
- Военный билет
- Удостоверение призывника

**Системные документы (system_documents):**
- Уведомления о постановке на учёт
- Выписки из реестра
- Решения военкомата

**Персональные документы (personal_documents):**
- Загруженные гражданином документы
- Справки, подтверждения

---

## Часть 3. Процесс работы с повестками

### 3.1. Статусная модель повестки

Повестка проходит через следующие статусы:

```
┌──────────────────┐
│ Сформирован      │ (системный, не виден гражданину)
│ проект*          │
└────────┬─────────┘
         │ Направлено на подпись военному комиссару
         ▼
┌──────────────────┐     ┌──────────────────┐
│ Подписана*       │────▶│ Проект повестки  │
│                  │     │ отклонён         │
└────────┬─────────┘     └──────────────────┘
         │ Нажатие кнопки направления
         ▼
┌──────────────────┐     ┌──────────────────┐
│ Направлена       │────▶│ Вручение не      │
│                  │     │ требуется        │
└────────┬─────────┘     └──────────────────┘
         │ 1. Отметка факта вручения
         │ 2. Истечение 7 дней с момента размещения
         ▼
┌──────────────────┐     ┌──────────────────┐
│ Вручена          │────▶│ Явка не          │
│                  │     │ требуется        │
└────────┬─────────┘     └──────────────────┘
         │ Отметка факта неявки
         ▼
┌──────────────────┐
│ Не явился        │
└────────┬─────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌────────┐ ┌────────────────┐
│Явился  │ │Не явился по    │
│после   │ │уважительной    │
│даты    │ │причине         │
└────────┘ └────────────────┘
    │
    ▼
┌──────────────────┐
│ Явился в         │ (конечный статус)
│ назначенную дату │
└──────────────────┘
```

> **Ключевой момент:** повестка считается автоматически врученной через 7 дней после размещения в Реестре повесток, даже если гражданин её не видел.

### 3.2. Структура повестки (subpoena)

```
subpoena
├── id, series, number — идентификаторы
├── recruit_id — ссылка на гражданина
├── department_id — военкомат
├── create_date — дата создания
├── send_date — дата направления
├── visit_date — назначенная дата явки
├── reason_id — причина вызова (справочник)
├── status_id — текущий статус
├── delivery_info (jsonb) — информация о вручении
├── track_number_postal_item — трек-номер почты
├── s3_url — ссылка на PDF повестки
├── sig_s3url — ссылка на электронную подпись
├── automatic_service_subpoena — дата автоматического вручения
├── automatic_application_measures — дата автоматического применения мер
└── finish_date — дата закрытия
```

### 3.3. Причины вызова (subpoena_reason)

| Код | Причина |
|-----|---------|
| 01 | Уточнение данных воинского учёта |
| 02 | Прохождение медицинского освидетельствования |
| 03 | Прохождение военных сборов |
| 04 | Призыв на военную службу |
| 05 | Мобилизация |
| ... | ... |

### 3.4. Информация о явке (subpoena_appearance)

```
subpoena_appearance
├── subpoena_id — повестка
├── fact_appearance — true/false (явился/не явился)
├── date_appearance — фактическая дата явки
├── nonappearance_info (jsonb) — причины неявки
└── created_date_time, change_date_time
```

### 3.5. Списки на вызов (summon_list)

Военкомат формирует списки граждан для массового вызова:

```
summon_list
├── id, number, title
├── department_id — военкомат
├── turnout_date — дата явки
├── summon_objective — причина вызова
├── delivery_method — способ направления
├── free_count — количество свободных слотов
├── status — статус списка
├── sign_date — дата подписания
├── sign_person — ФИО подписанта
└── sign_position — должность подписанта

summoned_list (связь многие-ко-многим)
├── summon_list_id
├── recruit_id
└── subpoena_id — созданная повестка
```

---

## Часть 4. Механизм ограничительных мер

### 4.1. Справочник мер (restriction)

| Код | Мера | Реализатор (ФОИВ) |
|-----|------|-------------------|
| 01 | Запрет на выезд за пределы РФ | ФСБ (Погранслужба) |
| 02 | Запрет на регистрацию ТС | ГИБДД |
| 03 | Запрет на регистрацию недвижимости | Росреестр |
| 04 | Запрет на получение кредитов | ЦБ/Банки |
| 05 | Запрет на регистрацию ИП | ФНС |
| ... | ... | ... |

### 4.2. Процесс введения ограничений

```
Неявка по повестке (subpoena_appearance.fact_appearance = false)
         │
         ▼
Автоматическое ожидание 20 дней
(поле automatic_application_measures в subpoena)
         │
         ▼
┌─────────────────────────────────────┐
│ Создание restriction_document      │
│ (type = ВВЕДЕНИЕ)                  │
│ - decision_number                  │
│ - decision_date                    │
│ - decision_reason = "Неявка"       │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Создание restriction_document_item │
│ для КАЖДОЙ меры из справочника     │
│ - restriction_id → конкретная мера │
│ - applied_date = текущая дата      │
│ - applied_fact = false (пока)      │
│ - foiv_code = код ведомства        │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Создание notification_item         │
│ для каждого ФОИВ                   │
│ - notification_code                │
│ - foiv_code                        │
│ - send_date                        │
└─────────────────────────────────────┘
         │
         ▼
Отправка через СМЭВ в каждый ФОИВ
         │
         ▼
Получение подтверждения
(status_applied = SUCCESS, applied_fact = true)
```

### 4.3. Процесс отмены ограничений

```
Явка гражданина (subpoena_appearance.fact_appearance = true)
         │
         ▼
┌─────────────────────────────────────┐
│ Создание restriction_document      │
│ (type = ОТМЕНА)                    │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Обновление restriction_document_item│
│ - restriction_document_cancel_id   │
│ - status_canceled = IN_PROGRESS    │
│ - cancel_date = текущая дата       │
└─────────────────────────────────────┘
         │
         ▼
Отправка уведомлений об отмене в ФОИВ
         │
         ▼
Получение подтверждения
(status_canceled = SUCCESS)
```

### 4.4. Мониторинг мер (mz_ervu_restriction_info)

Перехват и логирование всех запросов к ФОИВ:

```
restriction_info
├── request_id — ID запроса в СМЭВ
├── class — тип меры (например, "ERVU-AbroadForbiddenTemporary")
├── restriction_id → ссылка на меру
├── restriction_status — true (действует) / false (снята)
├── request_stamp — время запроса
└── received_smev_status — ответ от СМЭВ
```

---

## Часть 5. Личные кабинеты

### 5.1. ЛК физического лица (ЛК ФЛ)

Гражданин через ЕСИА может:
- Просматривать свои данные воинского учёта
- Видеть повестки
- Получать выписки из реестра
- Подавать заявления на актуализацию данных (через ЕПГУ)

### 5.2. ЛК юридического лица (ЛК ЮЛ)

Работодатели и образовательные организации обязаны передавать данные о сотрудниках/студентах.

**Процесс работы:**

```
1. Вход через ЕСИА (требуется роль "Ведение воинского учета")
         │
         ▼
2. Проверка наличия организации в ЕРВУ
         │
    ┌────┴────┐
    ▼         ▼
 Есть      Нет → Создание ЮЛ в ЕРВУ
    │
    ▼
3. Главная страница:
   ├── Данные организации
   ├── Журнал взаимодействия
   └── Блоки загрузки сведений
```

**Виды передаваемых сведений:**

| Форма | Описание |
|-------|----------|
| Форма 1 | Сведения о приёме/увольнении |
| Форма 2 | Изменения данных сотрудников (ФИО, адрес, семейное положение) |
| Форма 3 | Сообщение о гражданах, не состоящих, но обязанных состоять на учёте |
| Форма 4 | Ежегодный список мужчин 17 лет для первоначальной постановки |
| Форма 5 | Ежегодный список всех сотрудников, подлежащих учёту |

**Процесс загрузки файла:**

```
Загрузка файла (Excel/XML)
         │
         ▼
Временное хранилище (DMZ)
         │
         ▼
Проверка на вирусы (Kaspersky)
         │
    ┌────┴────┐
    ▼         ▼
 Чисто    Заражён → Удаление + уведомление пользователю
    │
    ▼
Безопасный буфер
         │
         ▼
Парсинг и валидация (ervu-import-service)
         │
         ▼
Обработка данных (ervu-person-registry)
         │
         ▼
Результат в Журнал взаимодействия
```

### 5.3. ЛК Реестра повесток (ЛК РП)

Отдельный портал для просмотра повесток и выписок. Интегрирован с основной системой через сервис `mz_mnsv-ervu-rp-summons-v2`.

**Архитектура ЛК РП:**

```
INTERNET                    DMZ                      ЗАКРЫТЫЙ СЕГМЕНТ
┌─────────┐            ┌─────────────┐            ┌──────────────────┐
│ ЛК РП   │───http────▶│ Web-сервер  │───kafka───▶│ ЛК РП Back       │
│ Front   │            │ ЛК ФЛ/ЮЛ   │            │                  │
│ (Микорд)│            └─────────────┘            │ ervu-person-     │
└─────────┘                                       │ registry         │
                                                  │                  │
                                                  │ ervu-subpoena-   │
                                                  │ registry         │
                                                  └──────────────────┘
```

---

## Часть 6. Импорт данных

### 6.1. Источники импорта

Данные поступают из множества источников:

| Источник | Тип данных | Формат |
|----------|------------|--------|
| ГИР ВУ (Минобороны) | Данные о военнообязанных | XML |
| ФНС | Данные о работодателях, ИП | XML через СМЭВ |
| СФР | Трудовой стаж | XML через СМЭВ |
| МВД | Паспортные данные | XML через СМЭВ |
| ЕПГУ | Заявления граждан | JSON |
| ЛК ЮЛ | Сведения от работодателей | Excel/XML |

### 6.2. Процесс импорта

```
Получение файла/сообщения
         │
         ▼
ervu-import-service
├── Валидация формата
├── Проверка дубликатов (file_hash)
├── Парсинг данных
└── Публикация в Kafka (ervu.import.objects)
         │
         ▼
ervu-person-registry / ervu-subpoena-registry
├── Сохранение/обновление данных
├── Генерация инцидентов при ошибках
└── Публикация результатов (ervu.import.object.results)
         │
         ▼
ervu-import-history-service
├── Логирование результатов
└── Формирование отчёта
```

### 6.3. Обработка изменений (ervu-preliminary-data)

При получении новых данных система не применяет их сразу, а создаёт записи для проверки:

| Таблица | Источник изменений |
|---------|-------------------|
| `gir_changes` | Изменения из ГИР ВУ |
| `smev_changes` | Изменения из СМЭВ |
| `user_changes` | Изменения от пользователей |
| `application_changes` | Изменения из заявлений |

Оператор военкомата может принять или отклонить изменения:
- `status = ACCEPTED` → данные применяются
- `status = DECLINED` → данные отклоняются

### 6.4. Инциденты (ervu-incidents)

При обнаружении проблем с данными создаются инциденты:

```
incident
├── recruit_id — гражданин
├── number — номер инцидента
├── status — статус (OPEN, RESOLVED)
├── text — описание проблемы
├── error_code_id → справочник ошибок
├── source_id → источник (импорт, СМЭВ, пользователь)
├── object — объект, вызвавший инцидент
├── reason — причина
├── registration_date — дата создания
└── resolve_date — дата решения
```

**Примеры инцидентов:**
- Дубликат записи (одинаковый СНИЛС)
- Несоответствие ФИО в разных источниках
- Невалидные паспортные данные
- Конфликт адресов регистрации

---

## Часть 7. Журналирование и аудит

### 7.1. Типы журналов

Система ведёт несколько журналов для полного аудита:

| Журнал | Назначение |
|--------|------------|
| `journal` | Общий журнал событий |
| `auth_journal` | Журнал аутентификации |
| `ui_action_journal` | Журнал действий пользователей в UI |
| `ui_admin_journal` | Журнал администрирования |
| `object_history` | История изменений объектов |
| `object_versions` | Версии объектов (полные снимки) |
| `import_journal_start/finish` | Журнал импорта |
| `proxy_gateway_event` | Журнал API-запросов |

### 7.2. История объектов (object_history)

Каждое изменение записи фиксируется:

```json
{
  "id": "28938c3b-...",
  "object_id": "6c1de361-...",
  "object_type": "Recruit",
  "operation_type": "UPDATE",
  "diff_by_internal": {
    "updated": [{
      "path": "systemPgsStatus",
      "oldValue": "REGISTERED",
      "newValue": "CALLED"
    }]
  },
  "source": "ЕРВУ",
  "time_created": "2024-04-01T15:20:12",
  "journal_id": "e47d4f25-...",
  "gateway_ray_id": "3cfc93f2-..."
}
```

### 7.3. Версионирование (object_versions)

Полные снимки объектов для возможности отката:

```
object_versions
├── object_id — идентификатор объекта
├── version — номер версии
├── object — сериализованный объект (binary, сжатый)
├── object_type — тип (Recruit, Subpoena, ...)
├── time_created — время создания версии
└── user_id — кто изменил
```

### 7.4. Журнал API-запросов (proxy_gateway_event)

Логирование всех HTTP-запросов:

```
proxy_gateway_event
├── event_type — REST
├── rest_method — GET/POST/PUT/DELETE
├── service_name — ervu-person-registry
├── full_path — /service/ervu-person-registry/recruits/123
├── response_code — 200
├── request_content_length — 1024
├── response_content_length — 2048
├── user_id — идентификатор пользователя
├── event_timestamp — время запроса
└── gateway_ray_id — уникальный ID для трассировки
```

---

## Часть 8. Межведомственное взаимодействие

### 8.1. Архитектура МВЗ

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ ЕРВУ            │     │ СМЭВ            │     │ ФОИВ            │
│                 │     │                 │     │ (ФНС, МВД,      │
│ mz-adapter ─────┼────▶│ Маршрутизация   │────▶│  СФР, ФСБ...)   │
│                 │     │ сообщений       │     │                 │
│ wf-smev-gateway │◀────┼─────────────────│◀────│                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 8.2. Типы межведомственных запросов

Мониторинг в таблице `ervu_interagencies_journal`:

| Внешняя система | Типы запросов |
|-----------------|---------------|
| СФР | `WorkExperienceResponse` (трудовой стаж) |
| МВД | `PassportValidityResponse` (проверка паспорта) |
| ФНС | `FNSLicIPRequest` (данные ИП) |
| ФСБ | `AbroadForbiddenTemporary` (запрет выезда) |
| ... | ... |

### 8.3. Структура МВЗ-журнала

```
ervu_interagencies_journal
├── id — идентификатор
├── message_id — ID сообщения в СМЭВ
├── mvz_names_id → справочник МВЗ
├── direction — request/response
├── vk_id — военкомат-инициатор
├── recruit_last_name, first_name, middle_name — ФИО
├── snils — СНИЛС
├── body — тело запроса/ответа (jsonb)
├── xml — оригинальный XML (bytea)
├── created_at, updated_at
└── commissariat_name — название ВК
```

### 8.4. Сервисы реализации МВЗ (mz_discovery)

Конфигурация маршрутизации запросов:

```
services
├── code — внутренний код (mz-mvd-registration)
├── federal_code — код в СМЭВ (2356SKFMS)
├── name — "МВД (сведения о регистрации)"
├── version — 1.00
├── link — ссылка на описание в СМЭВ
└── provider_id → поставщик (МВД, ФНС, ...)

scenario
├── service_id
├── clazz — класс сообщения
├── request — шаблон запроса
├── response — ожидаемый ответ
├── route — направление
└── enabled — включено/выключено
```

---

## Часть 9. Подсистема уведомлений

### 9.1. Архитектура

```
notifier-rest-entrypoint (API)
         │
         ▼ notifier.entrypoint.create
notifier-registry (хранение)
         │
         ▼ notifier.message.create
notifier-consumer-template (шаблонизация)
         │
    ┌────┴────┐
    ▼         ▼
notifier-consumer-notification    notifier-consumer-email
(Push в ЛК)                       (Email)
         │                              │
         ▼                              ▼
notifier-gateway              SMTP-сервер
```

### 9.2. Типы уведомлений

- Push-уведомления в личный кабинет
- Email-уведомления
- Уведомления через ЕПГУ (Госуслуги)

### 9.3. Шаблоны уведомлений (template_prefill)

```
template_prefill
├── service_id — идентификатор услуги
├── person_id — гражданин
├── status — статус отправки
├── notification_data — данные уведомления
├── person_data — данные ФЛ
├── legal_person — данные ЮЛ (для работодателей)
├── send_date, receive_date
└── mz_code, version — код и версия МВЗ
```

---

## Часть 10. Безопасность и контроль доступа

### 10.1. Интеграция с IDM

Система интегрирована с корпоративной системой управления идентификацией:

```
idm_person (пользователи)
├── id, full_name, email, phone, snils

idm_account (учётные записи)
├── person_id → пользователь
├── domain_id → организация
├── position — должность
├── work_mail

idm_domain (организации/ВК)
├── id, full_name
```

### 10.2. Контроль доступа к API (endpoints_access_info)

Каждый эндпоинт имеет настройки доступа:

```json
{
  "id": 1000000000408,
  "app_name": "ervu-person-registry",
  "method": "Post",
  "path": "/privateFile/v2/isValidQuittance",
  "rules": {
    "roles": ["military_recruit_specialist"],
    "perms": null
  }
}
```

### 10.3. Роли пользователей

| Роль | Описание |
|------|----------|
| `military_recruit_specialist` | Специалист ВК |
| `military_commissar` | Военный комиссар |
| `vu_responsible` | Ответственный за ВУ в организации |
| `system_admin` | Системный администратор |
| ... | ... |

---

## Часть 11. Выписки и справки

### 11.1. Типы выписок

Граждане и организации могут запрашивать выписки из реестра:

| Формат | Описание |
|--------|----------|
| 1 | Выписка о постановке на учёт |
| 2 | Выписка о повестках |
| 3 | Полная выписка со всеми данными |

### 11.2. Процесс формирования выписки

```
Запрос выписки (ЛК ФЛ / ЛК РП)
         │
         ▼
ervu-extract-from-registry-provider
├── Получение данных из ervu-person-registry
├── Получение повесток из ervu-subpoena-registry
├── Получение решений из ervu-decision-document-service
├── Получение истории из ervu-object-history-service
└── Формирование PDF (printer)
         │
         ▼
Подписание ЭП (s3urlsigner)
         │
         ▼
Сохранение в S3 (MinIO)
         │
         ▼
Возврат ссылки пользователю
```

### 11.3. Структура выписки (recruit_extract)

```
recruit_extract
├── id, number — идентификаторы
├── id_ern — ЕРН гражданина
├── recruit_id
├── format — тип выписки (1, 2, 3)
├── method — способ запроса (ERVU, EPGU)
├── status — RECEIVED, ERROR
├── recruit_info — данные гражданина (jsonb)
├── signer_info — данные подписанта (jsonb)
├── file_info — информация о файле (s3url, digest)
└── date — дата запроса
```

---

## Часть 12. Воинский учёт в организациях

### 12.1. BPMN-процесс

Диаграмма `Воинский_учет_граждан_в_организациях_Bpmn_v_2_4.pdf` описывает полный цикл:

```
Работодатель                    ЕРВУ                         Военкомат
     │                           │                              │
     │ Сведения о приёме         │                              │
     ├──────────────────────────▶│                              │
     │                           │ Обработка                    │
     │                           ├─────────────────────────────▶│
     │                           │                              │ Проверка
     │                           │◀─────────────────────────────┤
     │                           │ Результат                    │
     │◀──────────────────────────┤                              │
     │ Журнал взаимодействия     │                              │
     │                           │                              │
     │ Ежегодный список          │                              │
     ├──────────────────────────▶│                              │
     │                           │ Сверка с реестром            │
     │                           ├─────────────────────────────▶│
     │                           │                              │ Формирование
     │                           │                              │ списков на вызов
     │                           │◀─────────────────────────────┤
```

### 12.2. Обязанности организаций

По закону организации обязаны:

1. Сообщать о приёме/увольнении военнообязанных сотрудников (в течение 5 дней)
2. Сообщать об изменениях персональных данных (ФИО, адрес, семейное положение)
3. Выявлять граждан, не состоящих на учёте, но обязанных
4. Ежегодно предоставлять списки:
   - Юношей 17 лет для первоначальной постановки
   - Всех военнообязанных сотрудников

### 12.3. Журнал взаимодействия организации

Каждое действие организации фиксируется:

- Дата/время загрузки файла
- Тип сведений (форма 1-5)
- Статус обработки (принято, отклонено, ошибки)
- Количество записей
- Выявленные проблемы

---

## Часть 13. Архивация и удаление данных

### 13.1. Архивация записей (recruit_archive)

При определённых условиях записи архивируются:

```
recruit_archive
├── recruit_id — гражданин
├── archivation_reason_id → причина архивации
├── archive_data — архивные данные (jsonb)
├── vk_id — военкомат
├── hidden — признак скрытия
└── created_at, updated_at
```

**Причины архивации:**
- Смерть гражданина
- Достижение предельного возраста
- Эмиграция
- Признание негодным к службе

### 13.2. Запрос личного дела (recruit_private_file)

Механизм передачи личного дела между военкоматами:

```
recruit_private_file
├── recruit_id — гражданин
├── requested_recruitment_id — запрашивающий ВК
├── sending_recruitment_id — отправляющий ВК
├── status_id → статус (запрошено, отправлено, получено)
├── request_datetime — дата запроса
├── send_datetime — дата отправки
└── end_datetime — дата закрытия
```

---

## Часть 14. Отчётность и статистика

### 14.1. Генерация отчётов (stat-report-scheduler)

```
report
├── id, number — идентификаторы
├── department_id — организация/ВК
├── user_id, user_name — инициатор
├── query_definition_id → тип отчёта
├── params — параметры (jsonb)
├── status — статус генерации
├── s3uri, s3filename — файл отчёта
├── created_at, finished_at
└── parent_id — для составных отчётов
```

### 14.2. Типы отчётов

- Статистика по военнообязанным (по регионам, возрастам, категориям)
- Статистика по повесткам (направлено, вручено, явка)
- Статистика по ограничительным мерам
- Отчёты по импорту данных
- Аудиторские отчёты

---

## Заключение

ЕРВУ представляет собой масштабную федеральную систему, объединяющую:

- ~40 микросервисов на Java
- Интеграции с 10+ государственными системами через СМЭВ
- Три типа личных кабинетов (ФЛ, ЮЛ, Реестр повесток)
- Полное журналирование всех действий и изменений
- Автоматизацию процессов призыва и применения ограничительных мер

**Ключевые особенности:**

1. Автоматическое вручение повесток через 7 дней после публикации
2. Автоматическое применение мер через 20 дней после неявки
3. Агрегация данных из множества источников в единый профиль гражданина
4. Обязательная отчётность для всех организаций
5. Полная трассируемость всех операций
